/**
 * LeetCode 2756. Query Batching
 * 
 * –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ–ª–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–∏–Ω –∫—Ä—É–ø–Ω—ã–π –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π.
 * –ù–∞–ø–∏—à–∏—Ç–µ –∫–ª–∞—Å—Å QueryBatcher, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.
 *
 * –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:
 * 1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é queryMultiple, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫-–∫–ª—é—á–µ–π input –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç
 *    –ø—Ä–æ–º–∏—Å, —Ä–∞–∑—Ä–µ—à–∞—é—â–∏–π—Å—è –º–∞—Å—Å–∏–≤–æ–º –∑–Ω–∞—á–µ–Ω–∏–π —Ç–æ–π –∂–µ –¥–ª–∏–Ω—ã. –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç
 *    –∑–Ω–∞—á–µ–Ω–∏—é –¥–ª—è input[i]. –ú–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ –ø—Ä–æ–º–∏—Å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω.
 * 2. –í—Ä–µ–º—è —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥–∞ t –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö.
 *
 * –ö–ª–∞—Å—Å –∏–º–µ–µ—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥:
 * async getValue(key) ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É-–∫–ª—é—á –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–º–∏—Å —Å–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.
 * –ü–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã –≤ –∫–æ–Ω–µ—á–Ω–æ–º –∏—Ç–æ–≥–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏—é queryMultiple.
 * –§—É–Ω–∫—Ü–∏—è queryMultiple –Ω–µ –¥–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–æ–¥—Ä—è–¥ —á–∞—â–µ, —á–µ–º —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º t –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥.
 * –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ getValue queryMultiple –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º.
 * –ï—Å–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö t –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –º–µ—Ç–æ–¥ getValue –≤—ã–∑—ã–≤–∞–ª—Å—è —Å–Ω–æ–≤–∞, –≤—Å–µ –∫–ª—é—á–∏
 * –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –º–∞—Å—Å–∏–≤–æ–º –≤ queryMultiple, –∞ –∑–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è.
 * –ú–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ –∫–∞–∂–¥—ã–π –∫–ª—é—á —É–Ω–∏–∫–∞–ª–µ–Ω.
 * 
 * –ö–ª–∞—Å—Å QueryBatcher –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç (–±–∞—Ç—á–∏—Ç) –∑–∞–ø—Ä–æ—Å—ã
 * –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –≤—ã–∑–æ–≤–∞–º –º–µ—Ç–æ–¥–∞ getValue. –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –ø–µ—Ä–µ–¥–∞—ë—Ç –æ–¥–∏–Ω –∫–ª—é—á, 
 * –∞ QueryBatcher:
 * - –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç ¬´–æ–∫–Ω–æ¬ª –≤ throttleTime.
 * - –õ—é–±—ã–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã –≤ —Ç–µ—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–±–∏—Ä–∞–µ—Ç –≤ –º–∞—Å—Å–∏–≤ #throttledRequests.
 * - –ü–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ throttleTime –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ queryMultiple 
 *   –¥–ª—è –≤—Å–µ—Ö –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ–º –æ–∂–∏–¥–∞—é—â–∏–º –ø—Ä–æ–º–∏—Å–∞–º.
 * - –ó–∞—Ç–µ–º —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π throttleTime 
 *   –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –ø–æ–∫–∞ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å—ã.
 * 
 * –ö–ª–∞—Å—Å QueryBatcher –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–∫–µ—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
 * —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —á–∞—Å—Ç–æ—Ç—ã. –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —É–¥–∞–ª—ë–Ω–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É
 * –∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –∑–∞–¥–∞–Ω–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —á–∞—Å—Ç–æ—Ç–µ (rate limit).
 * 
 * –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
 * - –°–Ω–∏–∂–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥ –∑–∞ —Å—á–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–∏–Ω.
 * - –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ –∑–∞–ø—Ä–æ—Å–æ–≤ (rate limiting).
 * - –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–∑–∫–æ–º –≤—Å–ø–ª–µ—Å–∫–µ –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
 *
 * –ü—Ä–∏–º–µ—Ä 1:
 * –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
 * queryMultiple = async function(keys) {
 *   return keys.map(key => key + '!');
 * }
 * t = 100
 * calls = [
 *   {"key": "a", "time": 10},
 *   {"key": "b", "time": 20},
 *   {"key": "c", "time": 30}
 * ]
 * –í—ã—Ö–æ–¥:
 * [
 *   {"resolved": "a!", "time": 10},
 *   {"resolved": "b!", "time": 110},
 *   {"resolved": "c!", "time": 110}
 * ]
 * –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:
 * const batcher = new QueryBatcher(queryMultiple, 100);
 * setTimeout(() => batcher.getValue('a'), 10); // "a!" –≤ t=10–º—Å
 * setTimeout(() => batcher.getValue('b'), 20); // "b!" –≤ t=110–º—Å
 * setTimeout(() => batcher.getValue('c'), 30); // "c!" –≤ t=110–º—Å
 * –í t=10–º—Å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è getValue('a') ‚Üí queryMultiple(['a']) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É.
 * –í t=20–º—Å –∏ t=30–º—Å getValue('b') –∏ getValue('c') —Å—Ç–∞–≤—è—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å.
 * –í t=110–º—Å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è queryMultiple(['a', 'b']) –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Å—Ä–∞–∑—É.
 *
 * –ü—Ä–∏–º–µ—Ä 2:
 * –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
 * queryMultiple = async function(keys) {
 *   await new Promise(res => setTimeout(res, 100));
 *   return keys.map(key => key + '!');
 * }
 * t = 100
 * calls = [
 *   {"key": "a", "time": 10},
 *   {"key": "b", "time": 20},
 *   {"key": "c", "time": 30}
 * ]
 * –í—ã—Ö–æ–¥:
 * [
 *   {"resolved": "a!", "time": 110},
 *   {"resolved": "b!", "time": 210},
 *   {"resolved": "c!", "time": 210}
 * ]
 * –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–∏–º–µ—Ä—É 1, –Ω–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –≤ queryMultiple.
 *
 * –ü—Ä–∏–º–µ—Ä 3:
 * –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
 * queryMultiple = async function(keys) {
 *   await new Promise(res => setTimeout(res, keys.length * 100));
 *   return keys.map(key => key + '!');
 * }
 * t = 100
 * calls = [
 *   {"key": "a", "time": 10},
 *   {"key": "b", "time": 20},
 *   {"key": "c", "time": 30},
 *   {"key": "d", "time": 40},
 *   {"key": "e", "time": 250},
 *   {"key": "f", "time": 300}
 * ]
 * –í—ã—Ö–æ–¥:
 * [
 *   {"resolved": "a!", "time": 110},
 *   {"resolved": "e!", "time": 350},
 *   {"resolved": "b!", "time": 410},
 *   {"resolved": "c!", "time": 410},
 *   {"resolved": "d!", "time": 410},
 *   {"resolved": "f!", "time": 450}
 * ]
 * –ü–æ—è—Å–Ω–µ–Ω–∏–µ:
 * queryMultiple(['a']) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ t=10–º—Å –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤ t=110–º—Å
 * queryMultiple(['b','c','d']) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ t=110–º—Å –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤ t=410–º—Å
 * queryMultiple(['e']) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ t=250–º—Å –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤ t=350–º—Å
 * queryMultiple(['f']) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ t=350–º—Å –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤ t=450–º—Å
 */




/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –º–∞—Å—Å–∏–≤—É –∫–ª—é—á–µ–π.
 * @callback #queryMultipleFn
 * 
 * –ú–∞—Å—Å–∏–≤ –∫–ª—é—á–µ–π
 * @param {string[]} keys
 * 
 * –ü—Ä–æ–º–∏—Å, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
 * @returns {Promise<string[]>} 
 */

/**
 * –ó–∞–ø—Ä–æ—Å, –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –¥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞–∫–µ—Ç–∞.
 * @typedef {Object} ThrottledRequest
 * 
 * –ö–ª—é—á –∑–∞–ø—Ä–æ—Å–∞
 * @property {string} key 
 * 
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
 * @property {(result: string) => void} resolve 
 */

class QueryBatcher {
  #queryMultiple;
  #throttleTime;
  #isThrottling;
  #throttledRequests

  /**
   * –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–ª–∞—Å—Å–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ–ª—è
   * 
   * –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
   * @param {queryMultipleFn} queryMultiple 
   * 
   * –í—Ä–µ–º—è –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ –ø–∞–∫–µ—Ç–æ–≤ (–≤ –º—Å)
   * @param {number} throttleTime 
   */
  constructor(queryMultiple, throttleTime) {
    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    this.#queryMultiple = queryMultiple;

    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª throttle –º–µ–∂–¥—É –ø–∞–∫–µ—Ç–∞–º–∏
    this.#throttleTime = throttleTime;

    // —Ñ–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —á—Ç–æ —Å–µ–π—á–∞—Å –∏–¥—ë—Ç –ø–µ—Ä–∏–æ–¥ –æ–∂–∏–¥–∞–Ω–∏—è
    this.#isThrottling = false;

    // –º–∞—Å—Å–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–∞–∫–µ—Ç–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    this.#throttledRequests = [];
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –æ–¥–Ω–æ–º—É –∫–ª—é—á—É —Å —É—á—ë—Ç–æ–º –ø–∞–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
   * @param {string} key –ö–ª—é—á, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
   * @returns {Promise<string>} –ü—Ä–æ–º–∏—Å, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π —Å—Ç—Ä–æ–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   */
  async getValue(key) {
    // –ø—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ #throttleTime —Ä–∞–≤–µ–Ω –Ω—É–ª—é
    // —Å—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –º–∞—Å—Å–∏–≤–æ–º –∏–∑ –æ–¥–Ω–æ–≥–æ –∫–ª—é—á–∞
    // –±–µ—Ä—ë–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    if (!this.#throttleTime) {
      return (await this.#queryMultiple([key]))[0];
    }
    /**
     * 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥–∞
     *    - this.#isThrottling = true –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ–¥–∏–Ω –±–∞—Ç—á
     *      –∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ ¬´–∂–¥—É—â–µ–º¬ª –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ throttleTime.
     *
     * 2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–∏—Å–∞
     *    - –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–º–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—É–¥–µ—Ç —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è —Å—Ä–∞–∑—É.
     *    - –§—É–Ω–∫—Ü–∏—è-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø—Ä–æ–º–∏—Å–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç resolve.
     *    - –í–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –ø—Ä–æ–º–∏—Å–∞ –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é resolve –≤–º–µ—Å—Ç–µ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º key
     *      –≤ this.#throttledRequests: { key, resolve }.
     *    - –ó–∞ —Å—á—ë—Ç —ç—Ç–æ–≥–æ resolve ¬´–ø—Ä–∏–≤—è–∑–∞–Ω¬ª –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É key –∏ –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É –ø—Ä–æ–º–∏—Å—É.
     *    - –ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç #deThrottle(), –º—ã:
     *       1) –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏.
     *       2) –í—ã–ø–æ–ª–Ω—è–µ–º –µ–¥–∏–Ω—ã–π batch-–∑–∞–ø—Ä–æ—Å this.#queryMultiple(keys).
     *       3) –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π resolve(res),
     *          –∫–æ—Ç–æ—Ä—ã–π ¬´—Ä–∞–∑—Ä–µ—à–∞–µ—Ç¬ª –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç –ø—Ä–æ–º–∏—Å, —á—Ç–æ –±—ã–ª —Å–æ–∑–¥–∞–Ω –¥–ª—è —ç—Ç–æ–≥–æ key.
     *
     * 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
     *    - –í –º–∞—Å—Å–∏–≤ this.#throttledRequests –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç { key, resolve }.
     *    - key ‚Äî —Ç–æ—Ç –∂–µ –∫–ª—é—á, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –º—ã —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ.
     *    - resolve ‚Äî –∫–æ–ª–±—ç–∫, –≤—ã–∑–æ–≤ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ–∑–∂–µ ¬´–æ—Ç–ø—É—Å—Ç–∏—Ç¬ª –ø—Ä–æ–º–∏—Å –∏ –≤–µ—Ä–Ω—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
     *
     * 4. –ö–∞–∫ –ø—Ä–æ–º–∏—Å ¬´–æ–∂–∏–¥–∞–µ—Ç¬ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
     *    - –ü–æ–∫–∞ —ç—Ç–æ—Ç –ø—Ä–æ–º–∏—Å ¬´–≤ –ø–æ–¥–≤–µ—à–µ–Ω–Ω–æ–º¬ª —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –º–µ—Ç–æ–¥ getValue
     *      –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –≤—ã–∑—ã–≤–∞—é—â–µ–º—É –∫–æ–¥—É.
     *    - –í —Å–µ—Ä–µ–¥–∏–Ω–µ throttleTime –º—ã –Ω–µ —à–ª—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã,
     *      –∞ —Ç–æ–ª—å–∫–æ —Å–æ–±–∏—Ä–∞–µ–º –∫–ª—é—á–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ resolve-—Ñ—É–Ω–∫—Ü–∏–∏.
     *
     * 5. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
     *    - –ö–æ–≥–¥–∞ —Ç–∞–π–º–µ—Ä –≤—ã—Ç–µ—á–µ—Ç –∏ –≤—ã–∑–æ–≤–µ—Ç—Å—è #deThrottle(), 
     *      –º—ã —Å–æ–±–µ—Ä—ë–º –≤—Å–µ pending key‚Äô–∏ –≤ –æ–¥–∏–Ω batch –∏ –≤—ã–∑–æ–≤–µ–º queryMultiple(keys).
     *    - –ü–æ–ª—É—á–∏–≤ –º–∞—Å—Å–∏–≤ results, –ø—Ä–æ–±–µ–≥–∞–µ–º –ø–æ pending –∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ:
     *        pending[i].resolve(results[i])
     *      ‚Äî —ç—Ç–æ –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–∏—Å –∏ –æ—Ç–¥–∞—ë—Ç –∑–Ω–∞—á–µ–Ω–∏–µ
     *      —Ç—É–¥–∞, –≥–¥–µ –∫—Ç–æ-—Ç–æ –∂–¥–∞–ª getValue(key).
     */

    if (this.#isThrottling) {
      return new Promise((resolve) => {
        this.#throttledRequests.push({ key, resolve });
      });
    }

    // –∏–Ω–∞—á–µ –ø–æ–º–µ—á–∞–µ–º, —á—Ç–æ throttle-–æ–∫–Ω–æ –Ω–∞—á–∞–ª–æ—Å—å
    // –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ #deThrottle
    this.#isThrottling = true;
    setTimeout(() => this.#deThrottle(), this.#throttleTime);

    // —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∫–ª—é—á–∞
    // –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return (await this.#queryMultiple([key]))[0];
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ throttle-–æ–∫–Ω–∞.
   * –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –∑–∞ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å—ã –æ–¥–Ω–∏–º –ø–∞–∫–µ—Ç–æ–º
   * @private
   */
  async #deThrottle() {
    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –º–∞—Å—Å–∏–≤ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é pending,
     * —á—Ç–æ–±—ã –¥–∞–ª–µ–µ:
     * 1) –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Ç—É "–ø–∞—Ä—Ç–∏—é" –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–∫–æ–ø–∏–ª–∞—Å—å –∫ —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É.
     * 2) –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–±–Ω—É–ª–∏—Ç—å this.#throttledRequests = [] –∏ –Ω–∞—á–∞—Ç—å —Å–æ–±–∏—Ä–∞—Ç—å –Ω–æ–≤—É—é –æ—á–µ—Ä–µ–¥—å,
     *    –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—è —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π snapshot (pending).
     *
     * –ï—Å–ª–∏ –±—ã –º—ã –Ω–∞–ø—Ä—è–º—É—é —Ä–∞–±–æ—Ç–∞–ª–∏ —Å this.#throttledRequests –∏ —Å—Ä–∞–∑—É –∂–µ –µ–≥–æ –æ—á–∏—â–∞–ª–∏,
     * –º—ã –ø–æ—Ç–µ—Ä—è–ª–∏ –±—ã –¥–æ—Å—Ç—É–ø –∫ —Å–ø–∏—Å–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ–∫—É—â–µ–º –±–∞—Ç—á–µ.
     * 
     * –õ—é–±—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–∏—à–µ–¥—à–∏–µ –¥–æ —Å—Ç—Ä–æ–∫–∏ —Å this.#throttledRequests = [], –ø–æ–ø–∞–¥—É—Ç –≤
     * pending –∏ –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Å—Ä–∞–∑—É –≤ —Ç–µ–∫—É—â–µ–π ¬´–ø–∞—á–∫–µ¬ª.
     * 
     * –ö–∞–∫–∏–µ-—Ç–æ –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–∏—à–µ–¥—à–∏–µ –ø–æ—Å–ª–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ (=[]),
     * –±—É–¥—É—Ç –∑–∞–ø–∏—Å–∞–Ω—ã —É–∂–µ –≤ –Ω–æ–≤—ã–π this.#throttledRequests –∏ –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è:
     * –æ–Ω–∏ –¥–æ–∂–¥—É—Ç—Å—è —Å–ª–µ–¥—É—é—â–µ–≥–æ #deThrottle().
     */
    const pending = this.#throttledRequests;

    // –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ #isThrottling
    // –∏ –≤—ã—Ö–æ–¥–∏–º.
    if (!pending.length) {
      this.#isThrottling = false;
      return;
    }

    /**
     * 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π:
     *    const keys = pending.map(({ key }) => key);
     *    ‚Äî pending  ‚Äî –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ { key, resolve }.
     *    ‚Äî map –±–µ—Ä—ë—Ç –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–µ key,
     *      –≤ –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –ø—Ä–æ—Å—Ç—ã—Ö –∫–ª—é—á–µ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä ['a', 'b', 'c'].
     *
     * 2. –ì—Ä—É–ø–ø–æ–≤–æ–π –∑–∞–ø—Ä–æ—Å:
     *    this.#queryMultiple(keys)
     *    ‚Äî –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –ø–µ—Ä–µ–¥–∞—ë–º –≤–µ—Å—å –º–∞—Å—Å–∏–≤ keys.
     *    ‚Äî –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
     *      –æ—Ç–¥–∞—ë—Ç –º–∞—Å—Å–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ –∏ –∫–ª—é—á–∏.
     *    ‚Äî results ‚Äî –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä [valA, valB, valC].
     *
     * 3. –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Å –ø—Ä–æ–º–∏—Å–∞–º–∏:
     *    for (let i = 0; i < results.length; i++) {
     *      pending[i].resolve(results[i]);
     *    }
     *    ‚Äî –ø—Ä–æ—Ö–æ–¥–∏–º –ø–æ –º–∞—Å—Å–∏–≤—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∏–Ω–¥–µ–∫—Å—É i.
     *    ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±–µ—Ä—ë–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç pending[i],
     *      —É –Ω–µ–≥–æ –µ—Å—Ç—å resolve (—Å–≤—è–∑–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–Ω–µ–µ Promise).
     *    ‚Äî –≤—ã–∑—ã–≤–∞–µ–º pending[i].resolve(results[i]), —á—Ç–æ–±—ã ¬´–ø—Ä–æ–±—É–¥–∏—Ç—å¬ª –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç –ø—Ä–æ–º–∏—Å,
     *      –∫–æ—Ç–æ—Ä—ã–π –∂–¥–∞–ª —Å–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∫–ª—é—á–∞ pending[i].key.
     *
     * –†–µ–∑—é–º–µ:
     * –º—ã –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤ keys,
     * –≤—ã–ø–æ–ª–Ω—è–µ–º –µ–¥–∏–Ω—ã–π –ø–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏ –ø–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
     * –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ resolve-—Ñ—É–Ω–∫—Ü–∏–∏, –∑–∞–≤–µ—Ä—à–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–∏—Å—ã.
     */
    const keys = pending.map(({ key }) => key);
    const results = await this.#queryMultiple(keys)

    for (let i = 0; i < results.length; i++) {
      pending[i].resolve(results[i]);
    }

    // –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –æ—á–µ—Ä–µ–¥—å, –≥–æ—Ç–æ–≤—è—Å—å –∫ –Ω–æ–≤—ã–º
    // –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º.
    this.#throttledRequests = [];

    // –ø–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–∏—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    // –µ—Å–ª–∏ –≤ –Ω–æ–≤–æ–π –æ—á–µ—Ä–µ–¥–∏ –ø–æ¬≠—è–≤—è—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã, –æ–Ω–∏
    // –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ç–æ—Ç –∂–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª.
    setTimeout(() => this.#deThrottle(), this.#throttleTime);
  }
}





// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è assert, –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—â–∞—è –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.
function assert(condition, message) {
  if (!condition) {
    throw new Error(message);
  }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏.
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/*
  –¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã –¥–ª—è –∫–ª–∞—Å—Å–∞ QueryBatcher.
  –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
  –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–ª–∞—Å—Å QueryBatcher.
*/
const tests = [

  {
    description: "–ë–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏ (throttleTime=0) –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å—Ä–∞–∑—É",
    async test() {
      const calls = [];
      // stub: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–¥–∞ `val-<key>`
      const queryMultiple = async keys => {
        calls.push([...keys]);
        return keys.map(k => `val-${k}`);
      };
      const batcher = new QueryBatcher(queryMultiple, 0);

      const resA = await batcher.getValue("A");
      const resB = await batcher.getValue("B");

      assert(resA === "val-A", `–û–∂–∏–¥–∞–ª–æ—Å—å 'val-A', –ø–æ–ª—É—á–µ–Ω–æ '${resA}'`);
      assert(resB === "val-B", `–û–∂–∏–¥–∞–ª–æ—Å—å 'val-B', –ø–æ–ª—É—á–µ–Ω–æ '${resB}'`);

      // –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç–¥–µ–ª—å–Ω—ã–π
      assert(
        calls.length === 2 &&
        calls[0][0] === "A" &&
        calls[1][0] === "B",
        `–û–∂–∏–¥–∞–ª–æ—Å—å –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–∞, –ø–æ–ª—É—á–µ–Ω–æ: ${JSON.stringify(calls)}`
      );
    }
  },

  {
    description: "–ü–∞–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–≤—É—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–Ω–æ–º throttle –æ–∫–Ω–µ",
    async test() {
      const calls = [];
      const queryMultiple = async keys => {
        calls.push([...keys]);
        return keys.map(k => `res-${k}`);
      };
      const throttleTime = 50;
      const batcher = new QueryBatcher(queryMultiple, throttleTime);

      // –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–∫–Ω–æ
      const p1 = batcher.getValue("X");
      // –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è throttleTime: –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
      const p2 = batcher.getValue("Y");

      const r1 = await p1;
      const r2 = await p2;

      assert(r1 === "res-X", `–û–∂–∏–¥–∞–ª–æ—Å—å 'res-X', –ø–æ–ª—É—á–µ–Ω–æ '${r1}'`);
      assert(r2 === "res-Y", `–û–∂–∏–¥–∞–ª–æ—Å—å 'res-Y', –ø–æ–ª—É—á–µ–Ω–æ '${r2}'`);

      // –ñ–¥—ë–º —á—É—Ç—å –±–æ–ª—å—à–µ –æ–∫–Ω–∞, —á—Ç–æ–±—ã –ø–∞–∫–µ—Ç —Ç–æ—á–Ω–æ —É—à—ë–ª
      await sleep(throttleTime + 10);

      // –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ ‚Äì –æ—Ç–¥–µ–ª—å–Ω—ã–π, –≤—Ç–æ—Ä–æ–π ‚Äì –≤ –ø–∞–∫–µ—Ç–µ –∏–∑ –æ–¥–Ω–æ–≥–æ
      assert(
        calls.length === 2 &&
        JSON.stringify(calls[0]) === JSON.stringify(["X"]) &&
        JSON.stringify(calls[1]) === JSON.stringify(["Y"]),
        `–û–∂–∏–¥–∞–ª–æ—Å—å –¥–≤–∞ –≤—ã–∑–æ–≤–∞: ['X'], ['Y'], –ø–æ–ª—É—á–µ–Ω–æ ${JSON.stringify(calls)}`
      );
    }
  },

  {
    description: "–¢—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ –æ–¥–Ω–æ–º throttle –æ–∫–Ω–µ –ø–∞–∫–µ—Ç–∏—Ä—É—é—Ç—Å—è –≤–º–µ—Å—Ç–µ",
    async test() {
      const calls = [];
      const queryMultiple = async keys => {
        calls.push([...keys]);
        return keys.map(k => `${k.toLowerCase()}!`);
      };
      const throttleTime = 30;
      const batcher = new QueryBatcher(queryMultiple, throttleTime);

      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
      const p1 = batcher.getValue("A");
      // –î–≤–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ–∫–Ω–∞
      const p2 = batcher.getValue("B");
      const p3 = batcher.getValue("C");

      const r1 = await p1;
      const r2 = await p2;
      const r3 = await p3;

      assert(r1 === "a!", `–û–∂–∏–¥–∞–ª–æ—Å—å 'a!', –ø–æ–ª—É—á–µ–Ω–æ '${r1}'`);
      assert(r2 === "b!", `–û–∂–∏–¥–∞–ª–æ—Å—å 'b!', –ø–æ–ª—É—á–µ–Ω–æ '${r2}'`);
      assert(r3 === "c!", `–û–∂–∏–¥–∞–ª–æ—Å—å 'c!', –ø–æ–ª—É—á–µ–Ω–æ '${r3}'`);

      await sleep(throttleTime + 10);

      // –ü–µ—Ä–≤—ã–π ‚Äì –æ–¥–∏–Ω, –∑–∞—Ç–µ–º –ø–∞–∫–µ—Ç –∏–∑ B –∏ C
      assert(
        calls.length === 2 &&
        JSON.stringify(calls[0]) === JSON.stringify(["A"]) &&
        JSON.stringify(calls[1].sort()) === JSON.stringify(["B", "C"].sort()),
        `–û–∂–∏–¥–∞–ª–æ—Å—å –≤—ã–∑–æ–≤—ã: ['A'], ['B','C'], –ø–æ–ª—É—á–µ–Ω–æ ${JSON.stringify(calls)}`
      );
    }
  },

  {
    description: "–ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–∫–Ω–∞ –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å–Ω–æ–≤–∞ –∏–¥—É—Ç –æ–¥–∏–Ω–æ—á–Ω—ã–º–∏ –∏–ª–∏ –≤ –Ω–æ–≤–æ–º –ø–∞–∫–µ—Ç–µ",
    async test() {
      const calls = [];
      const queryMultiple = async keys => {
        calls.push([...keys]);
        return keys.map(k => k.repeat(2));
      };
      const throttleTime = 20;
      const batcher = new QueryBatcher(queryMultiple, throttleTime);

      // –ø–∞–∫–µ—Ç ‚Ññ1
      const r1 = await batcher.getValue("M");
      const r2 = await batcher.getValue("N");
      await sleep(throttleTime + 5);

      // –ø–∞–∫–µ—Ç ‚Ññ2
      const r3 = await batcher.getValue("P");
      await sleep(throttleTime + 5);

      assert(r1 === "MM", "r1 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'MM'");
      assert(r2 === "NN", "r2 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'NN'");
      assert(r3 === "PP", "r3 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'PP'");

      // –û–∂–∏–¥–∞–µ–º 3 –ø–∞–∫–µ—Ç–∞: ['M'], ['N'], ['P']
      assert(
        calls.length === 3 &&
        JSON.stringify(calls[0]) === JSON.stringify(["M"]) &&
        JSON.stringify(calls[1]) === JSON.stringify(["N"]) &&
        JSON.stringify(calls[2]) === JSON.stringify(["P"]),
        `–û–∂–∏–¥–∞–ª–æ—Å—å —Ç—Ä–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–∞, –ø–æ–ª—É—á–µ–Ω–æ ${JSON.stringify(calls)}`
      );
    }
  },

  {
    description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö",
    async test() {
      const queryMultiple = async keys => {
        // —ç–º—É–ª–∏—Ä—É–µ–º —Ä–∞–∑–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –æ—Ç–≤–µ—Ç–∞
        await sleep(keys[0].charCodeAt(0) % 10 * 5);
        return keys.map(k => k + "_OK");
      };
      const batcher = new QueryBatcher(queryMultiple, 40);

      // –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º D –∏ C –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
      const pD = batcher.getValue("D");
      const pC = batcher.getValue("C");

      const [resD, resC] = await Promise.all([pD, pC]);

      assert(resD === "D_OK", `–û–∂–∏–¥–∞–ª–æ—Å—å 'D_OK', –ø–æ–ª—É—á–µ–Ω–æ '${resD}'`);
      assert(resC === "C_OK", `–û–∂–∏–¥–∞–ª–æ—Å—å 'C_OK', –ø–æ–ª—É—á–µ–Ω–æ '${resC}'`);
    }
  },

];

// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤.
(async () => {
  console.log("–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è QueryBatcher...");
  let hasErrors = false;

  for (let i = 0; i < tests.length; i++) {
    try {
      await tests[i].test();
      console.log(`‚úîÔ∏è  –¢–µ—Å—Ç ${i + 1} –ø—Ä–æ–π–¥–µ–Ω: ${tests[i].description}`);
    } catch (e) {
      hasErrors = true;
      console.error(`‚ùå –¢–µ—Å—Ç ${i + 1} –Ω–µ –ø—Ä–æ–π–¥–µ–Ω: ${tests[i].description}`);
      console.error(e);
    }
  }

  if (hasErrors) {
    console.error("‚ùó –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π.");
  } else {
    console.log("üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –¥–ª—è QueryBatcher –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ.");
  }
})();
